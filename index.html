<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jelly Friends Pop</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(180deg, #fff9f0 0%, #ffeaf0 100%);
            --jelly-size: 46px;
            --col-cat: #2a2a2a; --col-fox: #ffaa5e; --col-sheep: #ffeebb;
            --col-frog: #88d498; --col-dog: #ffffff; --col-cow: #c4a6f5; --col-bunny: #ffb7b2;
        }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body {
            margin: 0; padding: 0; background: var(--bg-gradient);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif;
        }

        /* UI 디자인 */
        .game-header {
            width: 90%; max-width: 420px; display: flex; justify-content: space-between;
            padding: 15px 25px; background: white; border-radius: 30px;
            margin-bottom: 10px; border: 3px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.8rem; color: #999; font-weight: bold; }
        .stat-value { font-size: 1.5rem; font-weight: 900; color: #554433; }
        
        .fever-container { width: 90%; max-width: 420px; height: 12px; background: white; border-radius: 20px; margin-bottom: 20px; border: 2px solid #eee; overflow: hidden; }
        .fever-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #fecfef); transition: width 0.3s; }

        .grid-container { background: rgba(255,255,255,0.7); border-radius: 20px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 4px solid #fff; }
        .grid { display: grid; grid-template-columns: repeat(7, var(--jelly-size)); gap: 5px; }

        /* 동물 캐릭터 및 깨짐 방지 설정 */
        .cell { width: var(--jelly-size); height: var(--jelly-size); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .animal { width: 90%; height: 85%; position: relative; border-radius: 40% 40% 45% 45%; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.5), 0 3px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        
        /* 눈 공통 디자인 */
        .animal::after {
            content: ''; position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 30%;
            background-image: radial-gradient(circle at 30% 50%, #000 15%, transparent 16%), radial-gradient(circle at 70% 50%, #000 15%, transparent 16%),
                              radial-gradient(circle at 30% 50%, #fff 55%, transparent 56%), radial-gradient(circle at 70% 50%, #fff 55%, transparent 56%);
            background-size: 100% 100%; background-repeat: no-repeat; z-index: 2;
        }

        /* 개별 동물 특징 (깨짐 방지 처리) */
        .animal-0 { background-color: var(--col-cat); } /* 고양이 귀 */
        .animal-0::before { content: ''; position: absolute; top: -15%; left: 5%; width: 90%; height: 50%; background: inherit; clip-path: polygon(0% 100%, 20% 0%, 40% 100%, 60% 100%, 80% 0%, 100% 100%); }
        .animal-1 { background-color: var(--col-fox); } /* 여우 귀 */
        .animal-1::before { content: ''; position: absolute; top: -20%; left: 0%; width: 100%; height: 60%; background: inherit; clip-path: polygon(0% 100%, 15% 0%, 45% 100%, 55% 100%, 85% 0%, 100% 100%); }
        .animal-2 { background-color: var(--col-sheep); border-radius: 50%; } /* 양 */
        .animal-3 { background-color: var(--col-frog); } /* 개구리 */
        .animal-4 { background-color: var(--col-dog); border: 1px solid #eee; } /* 강아지 */
        .animal-5 { background-color: var(--col-cow); } /* 소 뿔 */
        .animal-5::before { content: ''; position: absolute; top: -10%; left: 15%; width: 70%; height: 30%; background: linear-gradient(to right, #9c7dd5 20%, transparent 20%, transparent 80%, #9c7dd5 80%); border-radius: 5px 5px 0 0; }
        .animal-6 { background-color: var(--col-bunny); } /* 토끼 귀 */
        .animal-6::before { content: ''; position: absolute; top: -35%; left: 10%; width: 80%; height: 50%; background: radial-gradient(ellipse at 20% 50%, var(--col-bunny) 40%, transparent 42%), radial-gradient(ellipse at 80% 50%, var(--col-bunny) 40%, transparent 42%); }

        .selected { transform: scale(1.15); filter: brightness(1.1); z-index: 10; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 40px; border-radius: 40px; text-align: center; border: 5px solid #ff9a9e; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn { background: #ff9a9e; border: none; padding: 15px 40px; color: white; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 0 #e08085; }
        
        @media (max-width: 400px) { :root { --jelly-size: 12.5vw; } }
    </style>
</head>
<body>
    <div class="game-header">
        <div class="stat-box"><div class="stat-label">TIME</div><div class="stat-value" id="time">60</div></div>
        <div class="stat-box"><div class="stat-label">SCORE</div><div class="stat-value" id="score">0</div></div>
    </div>
    <div class="fever-container"><div class="fever-fill" id="fever-fill"></div></div>
    <div class="grid-container"><div class="grid" id="grid"></div></div>
    <div class="modal" id="modal"><div class="modal-content"><h1>Finished!</h1><h2 id="final-score" style="font-size:3rem; color:#ff9a9e;">0</h2><button class="btn" onclick="startGame()">PLAY AGAIN</button></div></div>

<script>
    const ROWS = 7, COLS = 7;
    let grid = [], score = 0, timer = 60, selected = null, isBusy = false;

    function startGame() {
        score = 0; timer = 60; selected = null; isBusy = false;
        document.getElementById('modal').style.display = 'none';
        initGrid();
        updateUI();
        if (window.gameInterval) clearInterval(window.gameInterval);
        window.gameInterval = setInterval(() => {
            timer--; updateUI();
            if (timer <= 0) { clearInterval(window.gameInterval); showEnd(); }
        }, 1000);
    }

    function initGrid() {
        grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => Math.floor(Math.random() * 7)));
        while (checkMatches().length > 0) { // 시작부터 터지는 것 방지
            grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => Math.floor(Math.random() * 7)));
        }
        render();
    }

    function render() {
        const container = document.getElementById('grid');
        container.innerHTML = '';
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const ani = document.createElement('div');
                ani.className = `animal animal-${grid[r][c]}`;
                if (selected && selected.r === r && selected.c === c) ani.classList.add('selected');
                cell.onclick = () => handleClick(r, c);
                cell.appendChild(ani);
                container.appendChild(cell);
            }
        }
    }

    async function handleClick(r, c) {
        if (isBusy || timer <= 0) return;
        if (!selected) { selected = { r, c }; render(); } 
        else {
            const dist = Math.abs(selected.r - r) + Math.abs(selected.c - c);
            if (dist === 1) {
                isBusy = true;
                const r1 = selected.r, c1 = selected.c;
                swap(r1, c1, r, c);
                render();
                
                await new Promise(res => setTimeout(res, 250));
                
                if (checkMatches().length > 0) {
                    await processAllMatches();
                } else {
                    swap(r1, c1, r, c); // 매칭 안되면 복구
                }
                selected = null;
                isBusy = false;
            } else { selected = { r, c }; }
            render();
        }
    }

    function swap(r1, c1, r2, c2) { [grid[r1][c1], grid[r2][c2]] = [grid[r2][c2], grid[r1][c1]]; }

    function checkMatches() {
        let matched = new Set();
        // 가로
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS - 2; c++) {
                if (grid[r][c] !== -1 && grid[r][c] === grid[r][c+1] && grid[r][c] === grid[r][c+2]) {
                    matched.add(`${r},${c}`); matched.add(`${r},${c+1}`); matched.add(`${r},${c+2}`);
                }
            }
        }
        // 세로
        for (let c = 0; c < COLS; c++) {
            for (let r = 0; r < ROWS - 2; r++) {
                if (grid[r][c] !== -1 && grid[r][c] === grid[r+1][c] && grid[r][c] === grid[r+2][c]) {
                    matched.add(`${r},${c}`); matched.add(`${r+1},${c}`); matched.add(`${r+2},${c}`);
                }
            }
        }
        return Array.from(matched).map(s => s.split(',').map(Number));
    }

    async function processAllMatches() {
        let matches = checkMatches();
        while (matches.length > 0) {
            score += matches.length * 10;
            matches.forEach(([r, c]) => grid[r][c] = -1);
            updateUI();
            render();
            await new Promise(res => setTimeout(res, 300));
            
            fillEmpty();
            render();
            await new Promise(res => setTimeout(res, 300));
            matches = checkMatches();
        }
    }

    function fillEmpty() {
        for (let c = 0; c < COLS; c++) {
            let emptySpot = ROWS - 1;
            for (let r = ROWS - 1; r >= 0; r--) {
                if (grid[r][c] !== -1) {
                    grid[emptySpot][c] = grid[r][c];
                    if (emptySpot !== r) grid[r][c] = -1;
                    emptySpot--;
                }
            }
            for (let r = emptySpot; r >= 0; r--) grid[r][c] = Math.floor(Math.random() * 7);
        }
    }

    function updateUI() { 
        document.getElementById('score').innerText = score.toLocaleString(); 
        document.getElementById('time').innerText = timer; 
        document.getElementById('fever-fill').style.width = `${Math.min((score/2000)*100, 100)}%`;
    }
    
    function showEnd() {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('final-score').innerText = score.toLocaleString();
    }

    startGame();
</script>
</body>
</html>
