<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jelly Friends Pop</title>
    <style>
        :root {
            /* 배경 및 공통 변수 */
            --bg-gradient: linear-gradient(180deg, #fff9f0 0%, #ffeaf0 100%);
            --max-width: 420px;
            --gap: 5px;
            --jelly-size: 13vw; /* 모바일 반응형 크기 */
            
            /* 동물 색상 팔레트 (오리지널 버전 복원) */
            --col-cat: #2a2a2a;    /* 검은 고양이 */
            --col-fox: #ffaa5e;    /* 주황 여우 */
            --col-sheep: #ffeebb;  /* 노란 양 */
            --col-frog: #88d498;   /* 초록 개구리 */
            --col-dog: #ffffff;    /* 흰색 강아지 */
            --col-cow: #c4a6f5;    /* 보라 소 */
            --col-bunny: #ffb7b2;  /* 핑크 토끼 */
        }

        /* PC 화면 대응 */
        @media (min-width: 450px) { :root { --jelly-size: 52px; } }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-gradient); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; overflow: hidden; 
            font-family: "Segoe UI", sans-serif; 
        }

        /* --- 레이아웃: 좌우 너비 통일 --- */
        .layout-wrapper {
            width: 90%; 
            max-width: var(--max-width); 
            margin: 0 auto;
            position: relative;
        }

        /* 상단 헤더 */
        .game-header { 
            display: flex; justify-content: space-between; padding: 12px 25px; 
            background: white; border-radius: 30px; 
            border: 3px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
        }
        .stat-box { text-align: center; }
        .stat-label { font-size: 0.75rem; color: #999; font-weight: 800; letter-spacing: 1px; margin-bottom: 2px; }
        .stat-value { font-size: 1.5rem; font-weight: 900; color: #554433; }

        /* 피버 게이지 */
        .fever-container { 
            height: 12px; background: white; 
            border-radius: 20px; margin-bottom: 20px; overflow: hidden; border: 2px solid #eee; 
        }
        .fever-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #ffdde1); transition: width 0.3s; }

        /* 게임판 그리드 */
        .grid-container { 
            background: rgba(255,255,255,0.7); 
            border-radius: 20px; padding: 10px; 
            border: 4px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--gap); }

        /* --- [아이콘 디자인] 오리지널 스타일 복구 --- */
        .cell { aspect-ratio: 1/1; position: relative; cursor: pointer; z-index: 1; }
        
        /* 1. 몸통 (말랑한 둥근 사각형) */
        .animal { 
            width: 100%; height: 100%; 
            /* 원본의 젤리 모양 */
            border-radius: 40% 40% 45% 45%; 
            position: relative; z-index: 2; 
            transition: transform 0.15s; 
            /* 젤리 질감: 내부 광택 + 그림자 */
            box-shadow: 
                inset 2px 2px 5px rgba(255,255,255,0.7), 
                inset -2px -5px 5px rgba(0,0,0,0.1),
                0 3px 5px rgba(0,0,0,0.1);
        }

        /* 2. 눈 (왕눈이 스타일 복구) */
        .animal::after { 
            content: ''; position: absolute; 
            top: 35%; left: 50%; transform: translate(-50%, -50%); 
            width: 60%; height: 30%; 
            background-image: 
                radial-gradient(circle at 30% 50%, #000 15%, transparent 16%), /* 왼쪽 눈동자 */
                radial-gradient(circle at 70% 50%, #000 15%, transparent 16%), /* 오른쪽 눈동자 */
                radial-gradient(circle at 30% 50%, #fff 55%, transparent 56%), /* 왼쪽 흰자 */
                radial-gradient(circle at 70% 50%, #fff 55%, transparent 56%); /* 오른쪽 흰자 */
            background-size: 100% 100%; background-repeat: no-repeat;
            z-index: 3; 
        }

        /* 3. 귀/뿔 공통 (얼굴 뒤로) */
        .ear-base {
            content: ''; position: absolute; z-index: -1; background-color: inherit;
        }

        /* --- 동물별 디자인 (오류 수정 포함) --- */
        
        /* 0: 고양이 (검정) */
        .animal-0 { background-color: var(--col-cat); }
        .animal-0::before { 
            @extend .ear-base; content:''; position:absolute; z-index:-1; background:inherit;
            top: -15%; left: 5%; width: 90%; height: 50%; 
            -webkit-clip-path: polygon(0% 100%, 20% 0%, 40% 100%, 60% 100%, 80% 0%, 100% 100%);
            clip-path: polygon(0% 100%, 20% 0%, 40% 100%, 60% 100%, 80% 0%, 100% 100%);
        }

        /* 1: 여우 (주황) */
        .animal-1 { background-color: var(--col-fox); }
        .animal-1::before { 
            @extend .ear-base; content:''; position:absolute; z-index:-1; background:inherit;
            top: -20%; left: 0%; width: 100%; height: 60%; 
            -webkit-clip-path: polygon(0% 100%, 15% 0%, 45% 100%, 55% 100%, 85% 0%, 100% 100%);
            clip-path: polygon(0% 100%, 15% 0%, 45% 100%, 55% 100%, 85% 0%, 100% 100%);
        }

        /* 2: 양 (크림) */
        .animal-2 { 
            background-color: var(--col-sheep); 
            border-radius: 50%; 
            border: 2px dashed #eecfa1; 
        }
        .animal-2::before { /* 앞머리 */
            content: ''; position: absolute; top: 10%; left: -10%; width: 120%; height: 30%;
            background: linear-gradient(to right, #eecfa1 20%, transparent 20%, transparent 80%, #eecfa1 80%);
            border-radius: 20px;
        }

        /* 3: 개구리 (초록) */
        .animal-3 { background-color: var(--col-frog); border-radius: 45% 45% 40% 40%; }
        .animal-3::before { /* 입 */
            content: ''; position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            width: 30%; height: 15%; border-bottom: 3px solid #3d6e46; border-radius: 50%;
        }

        /* 4: 강아지 (흰색) */
        .animal-4 { background-color: var(--col-dog); border: 1px solid #eee; }
        .animal-4::before { /* 처진 귀 */
            content: ''; position: absolute; top: 0; left: -10%; width: 120%; height: 50%; z-index: -1;
            background: linear-gradient(to right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%);
            border-radius: 0 0 10px 10px;
        }

        /* 5: 소 (보라) */
        .animal-5 { 
            background-color: var(--col-cow); 
            background-image: radial-gradient(circle at 80% 80%, #9c7dd5 15%, transparent 16%), radial-gradient(circle at 20% 20%, #9c7dd5 10%, transparent 11%);
        }
        .animal-5::before { /* 뿔 */
            content: ''; position: absolute; top: -10%; left: 15%; width: 70%; height: 30%; z-index: -1;
            background: linear-gradient(to right, #9c7dd5 20%, transparent 20%, transparent 80%, #9c7dd5 80%);
            border-radius: 5px 5px 0 0;
        }

        /* 6: 토끼 (핑크) - [오류 수정: 배경 투명 + 그라데이션 귀] */
        .animal-6 { background-color: var(--col-bunny); }
        .animal-6::before { 
            content: ''; position: absolute; z-index: -1;
            top: -40%; left: 0; width: 100%; height: 50%;
            background-color: transparent; /* 중요: 배경색 없음 */
            background-image: 
                radial-gradient(ellipse at center, var(--col-bunny) 60%, transparent 62%),
                radial-gradient(ellipse at center, var(--col-bunny) 60%, transparent 62%);
            background-size: 30% 100%;
            background-position: 15% 0, 85% 0;
            background-repeat: no-repeat;
        }

        .selected .animal { transform: scale(1.15); filter: brightness(1.1); z-index: 10; animation: squish 0.5s infinite alternate; }
        @keyframes squish { from { transform: scale(1.15) translateY(0); } to { transform: scale(1.15, 1.05) translateY(-3px); } }

        /* --- 파티클 이펙트 --- */
        .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 100; animation: burst 0.6s ease-out forwards; }
        @keyframes burst { 
            0% { opacity: 1; transform: translate(0,0) scale(1); } 
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); } 
        }

        /* 모달 */
        .modal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 40px; border-radius: 40px; text-align: center; border: 5px solid #ff9a9e; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn { background: #ff9a9e; border: none; padding: 15px 40px; color: white; border-radius: 30px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 20px; box-shadow: 0 5px 0 #e08085; }
        .btn:active { transform: translateY(5px); box-shadow: none; }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <div class="game-header">
            <div class="stat-box"><div class="stat-label">TIME</div><div class="stat-value" id="time">60</div></div>
            <div class="stat-box"><div class="stat-label">SCORE</div><div class="stat-value" id="score">0</div></div>
        </div>
        
        <div class="fever-container"><div class="fever-fill" id="fever-fill"></div></div>
        
        <div class="grid-container"><div class="grid" id="grid"></div></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h1 style="color:#554433;">Finished!</h1>
            <h2 id="final-score" style="font-size:3.5rem; color:#ff9a9e; margin:10px 0;">0</h2>
            <button class="btn" onclick="startGame()">REPLAY</button>
        </div>
    </div>

<script>
    const ROWS = 7, COLS = 7;
    // 동물 색상 매핑 (파티클용)
    const ANIMAL_COLORS = ['#2a2a2a', '#ffaa5e', '#ffeebb', '#88d498', '#ffffff', '#c4a6f5', '#ffb7b2'];
    
    let grid = [], score = 0, timer = 60, selected = null, isBusy = false, combo = 0;
    const gridEl = document.getElementById('grid');

    function startGame() {
        score = 0; timer = 60; selected = null; isBusy = false; combo = 0;
        document.getElementById('modal').style.display = 'none';
        initGrid(); updateUI();
        if (window.gameInterval) clearInterval(window.gameInterval);
        window.gameInterval = setInterval(() => { timer--; updateUI(); if (timer <= 0) { clearInterval(window.gameInterval); showEnd(); } }, 1000);
    }

    function initGrid() {
        do { grid = Array.from({ length: ROWS }, () => Array.from({ length: COLS }, () => Math.floor(Math.random() * 7))); } while (findMatches().length > 0);
        render();
    }

    function render() {
        gridEl.innerHTML = '';
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                const type = grid[r][c];
                const cell = document.createElement('div'); cell.className = 'cell';
                
                const ani = document.createElement('div'); ani.className = `animal animal-${type}`;
                
                if (selected && selected.r === r && selected.c === c) cell.classList.add('selected');
                cell.onclick = () => handleClick(r, c);
                cell.appendChild(ani); gridEl.appendChild(cell);
            }
        }
    }

    async function handleClick(r, c) {
        if (isBusy || timer <= 0) return;
        if (!selected) { selected = { r, c }; render(); } 
        else {
            const dist = Math.abs(selected.r - r) + Math.abs(selected.c - c);
            if (dist === 1) {
                isBusy = true; const r1 = selected.r, c1 = selected.c;
                swap(r1, c1, r, c); render();
                await new Promise(res => setTimeout(res, 250));
                if (findMatches().length > 0) { combo = 0; await processMatches(); } else { swap(r1, c1, r, c); }
                selected = null; isBusy = false;
            } else { selected = { r, c }; }
            render();
        }
    }
    function swap(r1, c1, r2, c2) { [grid[r1][c1], grid[r2][c2]] = [grid[r2][c2], grid[r1][c1]]; }
    
    function findMatches() {
        let matched = new Set();
        for (let r=0; r<ROWS; r++) for (let c=0; c<COLS-2; c++) if (grid[r][c]!==-1 && grid[r][c]===grid[r][c+1] && grid[r][c]===grid[r][c+2]) { matched.add(`${r},${c}`); matched.add(`${r},${c+1}`); matched.add(`${r},${c+2}`); }
        for (let c=0; c<COLS; c++) for (let r=0; r<ROWS-2; r++) if (grid[r][c]!==-1 && grid[r][c]===grid[r+1][c] && grid[r][c]===grid[r+2][c]) { matched.add(`${r},${c}`); matched.add(`${r+1},${c}`); matched.add(`${r+2},${c}`); }
        return Array.from(matched).map(s => s.split(',').map(Number));
    }

    async function processMatches() {
        let matches = findMatches();
        while (matches.length > 0) {
            combo++; score += matches.length * 10 * combo;
            
            // --- 색상 파티클 이펙트 ---
            matches.forEach(([r, c]) => {
                if(grid[r][c] !== -1) {
                    createExplosion(r, c, ANIMAL_COLORS[grid[r][c]]); 
                    grid[r][c] = -1;
                }
            });
            
            updateUI(); render();
            await new Promise(res => setTimeout(res, 300));
            drop(); render();
            await new Promise(res => setTimeout(res, 300));
            matches = findMatches();
        }
    }

    function createExplosion(r, c, color) {
        const cellIndex = r * COLS + c; if (cellIndex >= gridEl.children.length) return;
        const cell = gridEl.children[cellIndex];
        const rect = cell.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
        
        for(let i=0; i<8; i++) {
            const p = document.createElement('div'); p.className = 'particle';
            p.style.backgroundColor = color;
            p.style.left = centerX + 'px'; p.style.top = centerY + 'px';
            const angle = Math.random() * Math.PI * 2; const dist = 30 + Math.random() * 40;
            p.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
            p.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
            document.body.appendChild(p); setTimeout(() => p.remove(), 600);
        }
    }

    function drop() { for (let c=0; c<COLS; c++) { let empty = ROWS-1; for (let r=ROWS-1; r>=0; r--) { if (grid[r][c] !== -1) { grid[empty][c] = grid[r][c]; if (empty !== r) grid[r][c] = -1; empty--; } } for (let r=empty; r>=0; r--) grid[r][c] = Math.floor(Math.random() * 7); } }
    function updateUI() { document.getElementById('score').innerText = score.toLocaleString(); document.getElementById('time').innerText = timer; document.getElementById('fever-fill').style.width = `${Math.min((combo/5)*100, 100)}%`; }
    function showEnd() { document.getElementById('modal').style.display = 'flex'; document.getElementById('final-score').innerText = score.toLocaleString(); }
    
    startGame();
</script>
</body>
</html>
